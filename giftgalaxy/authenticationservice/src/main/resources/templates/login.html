<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <section>
        <form id="loginForm" action="/login" method="post">
            <h1>Login</h1>
            <div class="inputbox">
                <ion-icon name="mail-outline"></ion-icon>
                <input name="username" id="username"type="email" required>
                <label for="">Email</label>
            </div>
            <div class="inputbox">
                <ion-icon name="lock-closed-outline"></ion-icon>
                <input name="password" id = "password" type="password" required>
                <label for="password">Password</label>
            </div>
            <div class="register">
                <p><a href="#">Forget Password?</a></p>
            </div>
            <button type="submit">Log in</button>
            <div class="register">
                <p>Don't have an account? <a href="/signup">Register!</a></p>
            </div>
        </form>
    </section>
</body>
</html>
<script>
    document.getElementById('loginForm').addEventListener('submit', function(event) {
    event.preventDefault();  // Prevent default form submission

    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    const data = {
        username: username,
        password: password
    };

    fetch('/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            return response.text();  // Get JWT token from the response
        } else {
            throw new Error('Login failed');
        }
    })
    .then(token => {
        console.log('JWT Token:', token);
        localStorage.setItem('jwtToken', token);  // Store the token in local storage
        alert('Login successful');

        // Fetch the /homepage content and render it dynamically
        fetch('/index', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + token  // Include the JWT token
            }
        })
        .then(response => {
            if (response.ok) {
                //window.location.href = '/index';
console.log("get index in login is executed")
var t = localStorage.getItem('jwtToken');  // Store the token in local storage
console.log(t);

                return response.text();  // Load the content of the /homepage page
                
                
            } else {
                throw new Error('Failed to load home page');
            }
        })
        .then(html => {
            document.body.innerHTML = html;  // Render the /homepage content in the current page
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load home page');
        });
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Login failed');
    });
});


</script>